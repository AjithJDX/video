<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Record Video</title>
</head>
<body>
  <div>
    <video style="width: 250px; height: 300px; background-color: red;" autoplay></video>
    <button id="recordBtn" onclick="recordVideo()" disabled>Record</button>
    <div id="timer"></div>
    <button id="switchBtn" onclick="switchCamera()">Switch</button>
  </div>

  <script>
    const videoEle = document.querySelector("video");
    const recordButton = document.getElementById("recordBtn");
    const switchButton = document.getElementById("switchBtn");
    const timerElement = document.getElementById("timer");
    let front = false;
    let mediaRecorder = null;
    let mediaStream = null;
    let recordedChunks = [];
    let timerInterval = null;
    let timerValue = 20;
    let isRecording = false;

    function switchCamera() {
      front = !front;
      const facingMode = front ? "user" : "environment";

      if (mediaStream) {
        const tracks = mediaStream.getTracks();
        tracks.forEach((track) => track.stop());
      }

      // Request a new media stream with the updated facingMode
      navigator.mediaDevices
        .getUserMedia({ video: { facingMode: facingMode } })
        .then((stream) => {
          mediaStream = stream;
          videoEle.srcObject = stream;
          recordButton.disabled = false;
          switchButton.disabled = false;
          console.log(stream);
        })
        .catch((error) => {
          console.error("Error accessing media devices:", error);
        });
    }

    function recordVideo() {
      if (isRecording) {
        mediaRecorder.stop();
        clearInterval(timerInterval);
        timerElement.innerText = "";
        recordButton.innerText = "Record";
        isRecording = false;
      } else {
        recordedChunks = [];
        timerValue = 20;
        timerElement.innerText = timerValue;

        mediaRecorder = new MediaRecorder(mediaStream);
        mediaRecorder.ondataavailable = handleDataAvailable;
        mediaRecorder.onstop = handleStop;

        mediaRecorder.start();
        timerInterval = setInterval(updateTimer, 1000);
        isRecording = true;
      }
    }

    function handleDataAvailable(event) {
      if (event.data.size > 0) {
        recordedChunks.push(event.data);
      }
    }

    function handleStop() {
      const recordedBlob = new Blob(recordedChunks, { type: "video/webm" });
      const recordedUrl = URL.createObjectURL(recordedBlob);
      console.log("Recorded Video URL:", recordedUrl);
    }

    function updateTimer() {
      timerValue--;
      timerElement.innerText = timerValue;

      if (timerValue === 10) {
        mediaRecorder.pause();
      } else if (timerValue <= 0) {
        recordButton.click(); // Stop recording
      }
    }

    // Initially, get the video stream with the default facing mode (front camera)
    switchCamera();
  </script>
</body>
</html>
