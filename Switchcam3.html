<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Record Video</title>
</head>
<body>
  <div>
    <video style="width: 250px; height: 300px; background-color: red;" autoplay></video>
    <button id="recordBtn" onclick="recordVideo()" disabled>Record</button>
    <div id="timer"></div>
    <button id="switchBtn" onclick="switchCamera()">Switch</button>
  </div>
  <textarea id="base64TextArea" style="width: 100%; height: 150px;" readonly></textarea>
  <button id="copyBtn" onclick="copyBase64()" disabled>Copy to Clipboard</button>

  <script>
    const videoEle = document.querySelector("video");
    const recordButton = document.getElementById("recordBtn");
    const switchButton = document.getElementById("switchBtn");
    const timerElement = document.getElementById("timer");
    const base64TextArea = document.getElementById("base64TextArea");
    const copyButton = document.getElementById("copyBtn");
    let front = false;
    let mediaRecorder = null;
    let mediaStream = null;
    let recordedChunks = [];
    let timerInterval = null;
    let timerValue = 20;

    function switchCamera() {
      front = !front;
      const facingMode = front ? "user" : "environment";

      if (mediaStream) {
        const tracks = mediaStream.getTracks();
        tracks.forEach((track) => track.stop());
      }

      // Request a new media stream with the updated facingMode
      navigator.mediaDevices
        .getUserMedia({ video: { facingMode: facingMode } })
        .then((stream) => {
          mediaStream = stream;
          videoEle.srcObject = stream;
          recordButton.disabled = false;
          switchButton.disabled = false;
          console.log(stream);
        })
        .catch((error) => {
          console.error("Error accessing media devices:", error);
        });
    }

    function recordVideo() {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        clearInterval(timerInterval);
      } else {
        recordedChunks = [];
        timerValue = 20;
        timerElement.innerText = timerValue;

        mediaRecorder = new MediaRecorder(mediaStream);
        mediaRecorder.ondataavailable = handleDataAvailable;
        mediaRecorder.onstop = handleStop;

        mediaRecorder.start();
        timerInterval = setInterval(updateTimer, 1000);
      }
    }

    function handleDataAvailable(event) {
      if (event.data.size > 0) {
        recordedChunks.push(event.data);
      }
    }

    function handleStop() {
      const recordedBlob = new Blob(recordedChunks, { type: "video/webm" });
      const recordedUrl = URL.createObjectURL(recordedBlob);
      console.log("Recorded Video URL:", recordedUrl);

      // Display base64 value of recorded video in the textarea
      const reader = new FileReader();
      reader.onloadend = function () {
        base64TextArea.value = reader.result;
        copyButton.disabled = false;
      };
      reader.readAsDataURL(recordedBlob);
    }

    function updateTimer() {
      timerValue--;
      timerElement.innerText = timerValue;

      if (timerValue === 10) {
        mediaRecorder.pause();
        recordButton.innerText = "Resume";
      }

      if (timerValue <= 0) {
        mediaRecorder.stop();
        clearInterval(timerInterval);
        recordButton.innerText = "Record";
      }
    }

    function copyBase64() {
      base64TextArea.select();
      document.execCommand("copy");
      alert("Base64 value copied to clipboard!");
    }

    // Initially, get the video stream with the default facing mode (front camera)
    switchCamera();
  </script>
</body>
</html>
